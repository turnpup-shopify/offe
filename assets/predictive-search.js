class PredictiveSearch extends HTMLElement{constructor(){super(),this.cached_results={},this.form=this.querySelector("form"),this.input=this.querySelector(".search--textbox"),this.link_selector=`a[href='${theme.urls.search}']`,this.loading=this.querySelector(".search--loading"),this.results=this.querySelector(".search--results"),this.search_trigger=document.querySelector('[data-trigger="search-modal"]'),this.types="product,"+("true"===this.getAttribute("data-show-articles")?"article,":"")+("true"===this.getAttribute("data-show-collections")?"collection,":"")+("true"===this.getAttribute("data-show-pages")?"page":""),this.updateLinks(),this.updateLinksListener(),this.listenForKeyEntered(),this.formSubmit()}updateLinks(){const{main_content:e,right_sidebar:t,left_sidebar:s}=theme.off_canvas;this.links={main:e.querySelectorAll(this.link_selector),right:t.querySelectorAll(this.link_selector),left:s.querySelectorAll(this.link_selector)},this.searchLinkListeners()}searchLinkListeners(){for(const t in this.links)this.links[t].length&&(this.links[t].off("click"),this.links[t].on("click",e=>{"left"===t&&theme.off_canvas.closeLeft(),"right"===t&&theme.off_canvas.closeRight(),setTimeout(()=>this.openModal(),"main"===t?0:450),e.preventDefault(),e.stopPropagation()}))}openModal(){this.search_trigger.click(),window.scrollTo(0,0),this.input.focus()}updateLinksListener(){window.on("theme:search:updateLinks",()=>this.updateLinks())}listenForKeyEntered(){this.input.on("input",()=>{var e=this.input.value.trim();if(!e.length)return this.show(!1,!1),void(this.abort_controller&&this.abort_controller.abort());this.getSearchResults(e)})}async getSearchResults(e){this.show(!1),this.abort_controller&&this.abort_controller.abort();var t=e.replace(" ","-").toLowerCase();if(this.cached_results[t])this.renderSearchResults(this.cached_results[t]);else{this.abort_controller=new AbortController;try{const i=await fetch(`${theme.urls.search}/suggest?q=${e}&resources[type]=${this.types}&resources[limit]=10&section_id=predictive-search`,{signal:this.abort_controller.signal});if(!i.ok)throw new Error(i.status);var s=await i.text(),r=theme.utils.parseHtml(s).innerHTML;this.cached_results[t]=r,this.renderSearchResults(r)}catch{}}}renderSearchResults(e){this.results.innerHTML=e;const t=this.querySelector(".predictive-search--products");t&&t.trigger("productsUpdated"),this.refineLinkListener(),this.show(!0)}refineLinkListener(){this.querySelectorAll(".predictive-search--refine").on("click",e=>{var t=e.target.getAttribute("data-url");t===""+location.pathname+location.search?(window.trigger("theme:modal:close"),setTimeout(()=>document.querySelector('[data-toggle-menu="refine-filter"]').click(),250)):location.href=t+"#filter--open"})}show(e,t=!e){this.results.style.opacity=e?"1":"0",this.loading.style.display=t?"block":"none"}formSubmit(){this.form.on("submit",e=>{e.preventDefault(),window.location.href=theme.urls.search+"?type=product&q="+this.input.value.trim()})}}customElements.define("predictive-search-root",PredictiveSearch);